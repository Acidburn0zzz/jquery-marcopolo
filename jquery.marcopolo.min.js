/**
 * Marco Polo v1.0.0
 *
 * A modern jQuery plugin for autocomplete functionality on a text input.
 *
 * https://github.com/jstayton/jquery-marcopolo
 *
 * Copyright Â© 2011 by Justin Stayton
 * Released under the MIT License
 * http://en.wikipedia.org/wiki/MIT_License
 */
(function(b){var l={};var g={cache:true,compare:null,data:{},delay:250,formatError:function(x,C,y,z,B,A){return"<em>Your search could not be completed at this time.</em>"},formatItem:function(z,x,A,y){return z.title||z.name},formatMinChars:function(z,x,A,y){return"<em>Your search must be at least <strong>"+z+"</strong> characters.</em>"},formatNoResults:function(z,x,A,y){return"<em>No results for <strong>"+z+"</strong>.</em>"},minChars:1,onChange:null,onFocus:null,onRequestBefore:null,onRequestAfter:null,onSelect:function(z,x,A,y){A.val(z.title||z.name)},required:false,selectable:"*",selected:null,url:null};var k={DOWN:40,ENTER:13,ESC:27,UP:38};var v=function(x){return x.children("li.mp_selectable:first")};var f=function(x){return x.children("li.mp_selectable:last")};var d=function(x){return x.children("li.mp_highlighted")};var j=function(x){return x.removeClass("mp_highlighted")};var c=function(x,y){j(d(y));return x.addClass("mp_highlighted")};var q=function(x){return c(v(x),x)};var o=function(z){var x=d(z);var y=x.prevAll("li.mp_selectable:first");if(!y.length){y=f(z)}return c(y,z)};var s=function(z){var x=d(z);var y=x.nextAll("li.mp_selectable:first");if(!y.length){y=v(z)}return c(y,z)};var e=function(x){return x.show()};var p=function(x){return x.hide()};var m=function(H,E,A,x,D){E.empty();if(b.isEmptyObject(D)){var J=b('<li class="mp_no_results" />');var F=A.formatNoResults&&A.formatNoResults.call(H,x,J,H,E);if(F){J.html(F).appendTo(E);e(E)}else{p(E)}}else{var B=H.data("marcoPolo").selected;var y=A.compare&&B&&B[A.compare];var z=false;for(var C=0,I;I=D[C];C++){var J=b('<li class="mp_item" />');var G=A.formatItem(I,J,H,E);J.data("marcoPolo",I);J.html(G).appendTo(E);if(y&&I[A.compare]===B[A.compare]){c(J,E);y=false;z=true}}E.children(A.selectable).addClass("mp_selectable");if(!z){q(E)}e(E)}};var w=function(E,y,z,A,D,C){y.empty();var x=b('<li class="mp_error" />');var B=z.formatError&&z.formatError.call(E,x,E,y,A,D,C);if(B){x.html(B).appendTo(y);e(y)}else{p(y)}};var r=function(C,y,z,A){if(!A.length){p(y).empty();return}y.empty();var x=b('<li class="mp_min_chars" />');var B=z.formatMinChars&&z.formatMinChars.call(C,z.minChars,x,C,y);if(B){x.html(B).appendTo(y);e(y)}else{p(y)}};var i=function(x){if(x.data("marcoPolo").ajax){x.data("marcoPolo").ajaxAborted=true;x.data("marcoPolo").ajax.abort()}else{x.data("marcoPolo").ajaxAborted=false}clearTimeout(x.data("marcoPolo").timer);return x.data("marcoPolo").ajaxAborted};var a=function(z,A,x,y){i(A);A.data("marcoPolo").timer=setTimeout(function(){if(z.length<y.minChars){r(A,x,y,z);return}var C=b.extend({q:z},y.data);var B=y.url+(y.url.indexOf("?")===-1?"?":"&")+b.param(C);if(y.cache&&l[B]){m(A,x,y,z,l[B])}else{y.onRequestBefore&&y.onRequestBefore.call(A,A,x);A.trigger("marcopolorequestbefore",[A,x]);A.data("marcoPolo").ajax=b.ajax({url:y.url,dataType:"json",data:C,success:function(D){m(A,x,y,z,D);l[B]=D},error:function(D,F,E){if(!A.data("marcoPolo").ajaxAborted){w(A,x,y,D,F,E)}},complete:function(D,E){A.data("marcoPolo").ajax=null;A.data("marcoPolo").ajaxAborted=false;y.onRequestAfter&&y.onRequestAfter.call(A,A,x,D,E);A.trigger("marcopolorequestafter",[A,x,D,E])}})}},y.delay)};var h=function(z,A,x,y){A.data("marcoPolo").selected=null;A.data("marcoPolo").value=z;y.onChange&&y.onChange.call(A,z,A,x);A.trigger("marcopolochange",[z,A,x]);a(z,A,x,y)};var n=function(A,x,B,y,z){p(y);B.data("marcoPolo").selected=A;z.onSelect&&z.onSelect.call(B,A,x,B,y);x.trigger("marcopoloselect",[A,x,B,y])};var u=function(z,x,y){i(z);if(y.required&&!z.data("marcoPolo").selected){z.val("")}p(x)};var t={init:function(x){return this.each(function(){var B=b(this);if(B.data("marcoPolo")){return}var A=B.attr("autocomplete");B.attr("autocomplete","off");var y=b('<ol class="mp_list" />').hide().insertAfter(B);var z=b.extend({},g,x);if(!z.url){z.url=B.closest("form").attr("action")}B.data("marcoPolo",{ajax:null,ajaxAborted:false,autocomplete:A,documentMouseup:null,focus:false,$list:y,mousedown:false,selected:null,settings:z,timer:null,value:B.val()});B.bind("focus.marcoPolo",function(){B.data("marcoPolo").focus=true;z.onFocus&&z.onFocus.call(B,B,y);B.trigger("marcopolofocus",[B,y]);a(B.val(),B,y,z)}).bind("keydown.marcoPolo",function(D){switch(D.which){case k.UP:D.preventDefault();o(y);e(y);break;case k.DOWN:D.preventDefault();s(y);e(y);break;case k.ENTER:D.preventDefault();var C=d(y);if(C.length){B.blur();n(C.data("marcoPolo"),C,B,y,z)}break;case k.ESC:u(B,y,z);break}}).bind("keyup.marcoPolo",function(C){if(B.val()!==B.data("marcoPolo").value){h(B.val(),B,y,z)}}).bind("blur.marcoPolo",function(){B.data("marcoPolo").focus=false;setTimeout(function(){if(B.data("marcoPolo").mousedown){return}u(B,y,z)},1)});y.mousedown(function(){B.data("marcoPolo").mousedown=true}).delegate("li.mp_selectable","mouseover",function(){c(b(this),y)}).delegate("li.mp_selectable","mouseout",function(){j(b(this))}).delegate("li.mp_selectable","mouseup",function(){var C=b(this);n(C.data("marcoPolo"),C,B,y,z)});B.data("marcoPolo").documentMouseup=function(){B.data("marcoPolo").mousedown=false;if(!B.data("marcoPolo").focus&&y.is(":visible")){u(B,y,z)}};b(document).bind("mouseup.marcoPolo",B.data("marcoPolo").documentMouseup);if(z.selected){n(z.selected,null,B,y,z)}})},destroy:function(){return this.each(function(){var y=b(this);var x=y.data("marcoPolo");if(!x){return}x.$list.remove();if(x.autocomplete!=="off"){y.removeAttr("autocomplete")}b(document).unbind("mouseup.marcoPolo",y.data("marcoPolo").documentMouseup);y.unbind(".marcoPolo").removeData("marcoPolo")})},option:function(A,y){var z=b(this);var x=z.data("marcoPolo");if(!x){return}if(typeof A==="undefined"){return x.settings}else{if(typeof y==="undefined"){if(b.isPlainObject(A)){x.settings=b.extend(x.settings,A)}else{return x.settings[A]}}else{x.settings[A]=y;return this}}},search:function(x){return this.each(function(){var z=b(this);var y=z.data("marcoPolo");if(!y){return}if(typeof x==="undefined"){x=z.val();a(x,z,y.$list,y.settings)}else{z.val(x);h(x,z,y.$list,y.settings)}})}};b.fn.marcoPolo=function(x){if(t[x]){return t[x].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof x==="object"||!x){return t.init.apply(this,arguments)}else{b.error("Method "+x+" does not exist on jQuery.marcoPolo")}}}})(jQuery);