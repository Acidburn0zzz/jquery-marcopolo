/**
 * Marco Polo v1.2.2
 *
 * A modern jQuery plugin for autocomplete functionality on a text input.
 *
 * https://github.com/jstayton/jquery-marcopolo
 *
 * Copyright 2011 by Justin Stayton
 * Released under the MIT License
 * http://en.wikipedia.org/wiki/MIT_License
 */
(function(b){var l={};var g={cache:true,compare:false,data:{},delay:250,formatData:null,formatError:function(B,G,C,D,F,E){return"<em>Your search could not be completed at this time.</em>"},formatItem:function(D,B,E,C){return D.title||D.name},formatMinChars:function(D,B,E,C){return"<em>Your search must be at least <strong>"+D+"</strong> characters.</em>"},formatNoResults:function(D,B,E,C){return"<em>No results for <strong>"+D+"</strong>.</em>"},hideOnSelect:true,label:null,minChars:1,onChange:null,onError:null,onFocus:null,onMinChars:null,onNoResults:null,onRequestBefore:null,onRequestAfter:null,onResults:null,onSelect:function(D,B,E,C){E.val(D.title||D.name)},param:"q",required:false,selectable:"*",selected:null,url:null};var k={DOWN:40,ENTER:13,ESC:27,UP:38};var r=function(B,C){if(!B.url){B.url=C.closest("form").attr("action")}if(B.label){B.label=b(B.label).addClass("mp_label");A(B.label,C)}return B};var v=function(B,C){if(B&&!C.val()){B.show();return true}else{return false}};var A=function(B,C){if(B&&(typeof C==="undefined"||C.val())){B.hide();return true}else{return false}};var n=function(B,C){if(B){if(C.val()){B.hide()}else{B.show()}return true}else{return false}};var y=function(B){return B.children("li.mp_selectable:visible:first")};var f=function(B){return B.children("li.mp_selectable:visible:last")};var d=function(B){return B.children("li.mp_highlighted")};var j=function(B){return B.removeClass("mp_highlighted")};var c=function(B,C){j(d(C));return B.addClass("mp_highlighted")};var s=function(B){return c(y(B),B)};var q=function(D){var B=d(D);var C=B.prevAll("li.mp_selectable:visible:first");if(!C.length){C=f(D)}return c(C,D)};var u=function(D){var B=d(D);var C=B.nextAll("li.mp_selectable:visible:first");if(!C.length){C=y(D)}return c(C,D)};var e=function(B){return B.show()};var p=function(B){return B.hide()};var m=function(M,I,E,B,H){I.empty();if(E.formatData){H=E.formatData.call(M,H,M,I)}if(b.isEmptyObject(H)){var O=b('<li class="mp_no_results" />');var K=E.formatNoResults&&E.formatNoResults.call(M,B,O,M,I);K&&O.html(K);E.onNoResults&&E.onNoResults.call(M,B,O,M,I);M.trigger("marcopolonoresults",[B,O,M,I]);if(K){O.appendTo(I);e(I)}else{p(I)}}else{var F=M.data("marcoPolo").selected;var C=E.compare&&F;var P;var D;var J=false;for(var G=0,N;N=H[G];G++){var O=b('<li class="mp_item" />');var L=E.formatItem.call(M,N,O,M,I);O.data("marcoPolo",N);O.html(L).appendTo(I);if(C){if(E.compare===true){P=N;D=F}else{P=N[E.compare];D=F[E.compare]}if(P===D){c(O,I);C=false;J=true}}}I.children(E.selectable).addClass("mp_selectable");E.onResults&&E.onResults.call(M,H,M,I);M.trigger("marcopoloresults",[H,M,I]);e(I);if(!J){s(I)}}};var z=function(I,C,D,E,H,G){C.empty();var B=b('<li class="mp_error" />');var F=D.formatError&&D.formatError.call(I,B,I,C,E,H,G);F&&B.html(F);D.onError&&D.onError.call(I,B,I,C,E,H,G);I.trigger("marcopoloerror",[B,I,C,E,H,G]);if(F){B.appendTo(C);e(C)}else{p(C)}};var t=function(G,C,D,E){if(!E.length){p(C).empty();return}C.empty();var B=b('<li class="mp_min_chars" />');var F=D.formatMinChars&&D.formatMinChars.call(G,D.minChars,B,G,C);F&&B.html(F);D.onMinChars&&D.onMinChars.call(G,D.minChars,B,G,C);G.trigger("marcopolominchars",[D.minChars,B,G,C]);if(F){B.appendTo(C);e(C)}else{p(C)}};var i=function(B){if(B.data("marcoPolo").ajax){B.data("marcoPolo").ajaxAborted=true;B.data("marcoPolo").ajax.abort()}else{B.data("marcoPolo").ajaxAborted=false}clearTimeout(B.data("marcoPolo").timer);return B.data("marcoPolo").ajaxAborted};var h=function(D,E,B,C){E.data("marcoPolo").selected=null;E.data("marcoPolo").value=D;C.onChange&&C.onChange.call(E,D,E,B);E.trigger("marcopolochange",[D,E,B])};var a=function(D,E,B,C){i(E);if(D!==E.data("marcoPolo").value){h(D,E,B,C)}E.data("marcoPolo").timer=setTimeout(function(){if(D.length<C.minChars){t(E,B,C,D);return}var H={};H[C.param]=D;var G=b.extend({},C.data,H);var F=C.url+(C.url.indexOf("?")===-1?"?":"&")+b.param(G);if(C.cache&&l[F]){m(E,B,C,D,l[F])}else{C.onRequestBefore&&C.onRequestBefore.call(E,E,B);E.trigger("marcopolorequestbefore",[E,B]);$inputParent=E.parent().addClass("mp_busy");E.data("marcoPolo").ajax=b.ajax({url:C.url,dataType:"json",data:G,success:function(I){m(E,B,C,D,I);l[F]=I},error:function(I,K,J){if(!E.data("marcoPolo").ajaxAborted){z(E,B,C,I,K,J)}},complete:function(I,J){E.data("marcoPolo").ajax=null;E.data("marcoPolo").ajaxAborted=false;$inputParent.removeClass("mp_busy");C.onRequestAfter&&C.onRequestAfter.call(E,E,B,I,J);E.trigger("marcopolorequestafter",[E,B,I,J])}})}},C.delay)};var o=function(E,B,F,C,D){if(D.hideOnSelect){p(C)}F.data("marcoPolo").selected=E;D.onSelect&&D.onSelect.call(F,E,B,F,C);F.trigger("marcopoloselect",[E,B,F,C]);F.data("marcoPolo").value=F.val()};var x=function(D,B,C){i(D);if(C.required&&!D.data("marcoPolo").selected){D.val("")}p(B)};var w={init:function(B){return this.each(function(){var F=b(this);if(F.data("marcoPolo")){return}var E=F.attr("autocomplete");F.attr("autocomplete","off");var C=b('<ol class="mp_list" />').hide().insertAfter(F);var D=r(b.extend({},g,B),F);F.data("marcoPolo",{ajax:null,ajaxAborted:false,autocomplete:E,documentMouseup:null,focus:false,$list:C,mousedown:false,selected:null,selectedMouseup:false,settings:D,timer:null,value:F.val()});F.bind("focus.marcoPolo",function(){F.data("marcoPolo").focus=true;A(D.label);if(F.data("marcoPolo").selectedMouseup){F.data("marcoPolo").selectedMouseup=false}else{D.onFocus&&D.onFocus.call(F,F,C);F.trigger("marcopolofocus",[F,C]);a(F.val(),F,C,D)}}).bind("keydown.marcoPolo",function(H){switch(H.which){case k.UP:H.preventDefault();e(C);q(C);break;case k.DOWN:H.preventDefault();e(C);u(C);break;case k.ENTER:H.preventDefault();var G=d(C);if(G.length){o(G.data("marcoPolo"),G,F,C,D)}break;case k.ESC:x(F,C,D);break}}).bind("keyup.marcoPolo",function(G){if(F.val()!==F.data("marcoPolo").value){a(F.val(),F,C,D)}}).bind("blur.marcoPolo",function(){F.data("marcoPolo").focus=false;setTimeout(function(){if(!F.data("marcoPolo").mousedown){x(F,C,D);v(D.label,F);C.empty()}},1)});C.mousedown(function(){F.data("marcoPolo").mousedown=true}).delegate("li.mp_selectable","mouseover",function(){c(b(this),C)}).delegate("li.mp_selectable","mouseout",function(){j(b(this))}).delegate("li.mp_selectable","mouseup",function(){var G=b(this);o(G.data("marcoPolo"),G,F,C,D);F.data("marcoPolo").selectedMouseup=true;F.focus()});F.data("marcoPolo").documentMouseup=function(){F.data("marcoPolo").mousedown=false;if(!F.data("marcoPolo").focus&&C.is(":visible")){x(F,C,D);v(D.label,F);C.empty()}};b(document).bind("mouseup.marcoPolo",F.data("marcoPolo").documentMouseup);if(D.selected){o(D.selected,null,F,C,D)}A(D.label,F)})},change:function(B){return this.each(function(){var F=b(this);var E=F.data("marcoPolo");var C=E.$list;var D=E.settings;if(!E){return}if(B!==E.value){F.val(B);if(E.focus){x(F,C,D);C.empty()}else{n(D.label,F)}h(B,F,C,D)}})},destroy:function(){return this.each(function(){var E=b(this);var D=E.data("marcoPolo");var B=D.$list;var C=D.settings;if(!D){return}B.remove();if(D.autocomplete!=="off"){E.removeAttr("autocomplete")}if(C.label){C.label.removeClass("mp_label")}b(document).unbind("mouseup.marcoPolo",E.data("marcoPolo").documentMouseup);E.unbind(".marcoPolo").removeData("marcoPolo")})},option:function(F,D){if(typeof F==="undefined"){var E=b(this);var C=E.data("marcoPolo");var B=C.settings;if(!C){return}return B}else{if(typeof D==="undefined"){if(b.isPlainObject(F)){return this.each(function(){var I=b(this);var H=I.data("marcoPolo");var G=H.settings;if(!H){return}G=b.extend(G,F);r(G,I)})}else{var E=b(this);var C=E.data("marcoPolo");var B=C.settings;if(!C){return}return B[F]}}else{return this.each(function(){var I=b(this);var H=I.data("marcoPolo");var G=H.settings;if(!H){return}G[F]=D;r(G,I)})}}},search:function(B){return this.each(function(){var D=b(this);var C=D.data("marcoPolo");if(!C){return}if(typeof B!=="undefined"){D.val(B)}D.focus()})}};b.fn.marcoPolo=function(B){if(w[B]){return w[B].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof B==="object"||!B){return w.init.apply(this,arguments)}else{b.error("Method "+B+" does not exist on jQuery.marcoPolo")}}}})(jQuery);