/**
 * Marco Polo v1.2.0
 *
 * A modern jQuery plugin for autocomplete functionality on a text input.
 *
 * https://github.com/jstayton/jquery-marcopolo
 *
 * Copyright 2011 by Justin Stayton
 * Released under the MIT License
 * http://en.wikipedia.org/wiki/MIT_License
 */
(function(b){var l={};var g={cache:true,compare:false,data:{},delay:250,formatData:null,formatError:function(A,F,B,C,E,D){return"<em>Your search could not be completed at this time.</em>"},formatItem:function(C,A,D,B){return C.title||C.name},formatMinChars:function(C,A,D,B){return"<em>Your search must be at least <strong>"+C+"</strong> characters.</em>"},formatNoResults:function(C,A,D,B){return"<em>No results for <strong>"+C+"</strong>.</em>"},hideOnSelect:true,label:null,minChars:1,onChange:null,onError:null,onFocus:null,onMinChars:null,onNoResults:null,onRequestBefore:null,onRequestAfter:null,onResults:null,onSelect:function(C,A,D,B){D.val(C.title||C.name)},param:"q",required:false,selectable:"*",selected:null,url:null};var k={DOWN:40,ENTER:13,ESC:27,UP:38};var p=function(A,B){if(!A.url){A.url=B.closest("form").attr("action")}if(A.label){A.label=b(A.label).addClass("mp_label");z(A.label,B)}return A};var u=function(A,B){if(A&&!B.val()){A.show();return true}else{return false}};var z=function(A,B){if(A&&(typeof B==="undefined"||B.val())){A.hide();return true}else{return false}};var x=function(A){return A.children("li.mp_selectable:visible:first")};var f=function(A){return A.children("li.mp_selectable:visible:last")};var d=function(A){return A.children("li.mp_highlighted")};var j=function(A){return A.removeClass("mp_highlighted")};var c=function(A,B){j(d(B));return A.addClass("mp_highlighted")};var r=function(A){return c(x(A),A)};var o=function(C){var A=d(C);var B=A.prevAll("li.mp_selectable:visible:first");if(!B.length){B=f(C)}return c(B,C)};var t=function(C){var A=d(C);var B=A.nextAll("li.mp_selectable:visible:first");if(!B.length){B=x(C)}return c(B,C)};var e=function(A){return A.show()};var q=function(A){return A.hide()};var m=function(L,H,D,A,G){H.empty();if(D.formatData){G=D.formatData.call(L,G,L,H)}if(b.isEmptyObject(G)){var N=b('<li class="mp_no_results" />');var J=D.formatNoResults&&D.formatNoResults.call(L,A,N,L,H);J&&N.html(J);D.onNoResults&&D.onNoResults.call(L,A,N,L,H);L.trigger("marcopolonoresults",[A,N,L,H]);if(J){N.appendTo(H);e(H)}else{q(H)}}else{var E=L.data("marcoPolo").selected;var B=D.compare&&E;var O;var C;var I=false;for(var F=0,M;M=G[F];F++){var N=b('<li class="mp_item" />');var K=D.formatItem.call(L,M,N,L,H);N.data("marcoPolo",M);N.html(K).appendTo(H);if(B){if(D.compare===true){O=M;C=E}else{O=M[D.compare];C=E[D.compare]}if(O===C){c(N,H);B=false;I=true}}}H.children(D.selectable).addClass("mp_selectable");D.onResults&&D.onResults.call(L,G,L,H);L.trigger("marcopoloresults",[G,L,H]);e(H);if(!I){r(H)}}};var y=function(H,B,C,D,G,F){B.empty();var A=b('<li class="mp_error" />');var E=C.formatError&&C.formatError.call(H,A,H,B,D,G,F);E&&A.html(E);C.onError&&C.onError.call(H,A,H,B,D,G,F);H.trigger("marcopoloerror",[A,H,B,D,G,F]);if(E){A.appendTo(B);e(B)}else{q(B)}};var s=function(F,B,C,D){if(!D.length){q(B).empty();return}B.empty();var A=b('<li class="mp_min_chars" />');var E=C.formatMinChars&&C.formatMinChars.call(F,C.minChars,A,F,B);E&&A.html(E);C.onMinChars&&C.onMinChars.call(F,C.minChars,A,F,B);F.trigger("marcopolominchars",[C.minChars,A,F,B]);if(E){A.appendTo(B);e(B)}else{q(B)}};var i=function(A){if(A.data("marcoPolo").ajax){A.data("marcoPolo").ajaxAborted=true;A.data("marcoPolo").ajax.abort()}else{A.data("marcoPolo").ajaxAborted=false}clearTimeout(A.data("marcoPolo").timer);return A.data("marcoPolo").ajaxAborted};var h=function(C,D,A,B){D.data("marcoPolo").selected=null;D.data("marcoPolo").value=C;B.onChange&&B.onChange.call(D,C,D,A);D.trigger("marcopolochange",[C,D,A])};var a=function(C,D,A,B){i(D);if(C!==D.data("marcoPolo").value){h(C,D,A,B)}D.data("marcoPolo").timer=setTimeout(function(){if(C.length<B.minChars){s(D,A,B,C);return}var G={};G[B.param]=C;var F=b.extend({},B.data,G);var E=B.url+(B.url.indexOf("?")===-1?"?":"&")+b.param(F);if(B.cache&&l[E]){m(D,A,B,C,l[E])}else{B.onRequestBefore&&B.onRequestBefore.call(D,D,A);D.trigger("marcopolorequestbefore",[D,A]);$inputParent=D.parent().addClass("mp_busy");D.data("marcoPolo").ajax=b.ajax({url:B.url,dataType:"json",data:F,success:function(H){m(D,A,B,C,H);l[E]=H},error:function(H,J,I){if(!D.data("marcoPolo").ajaxAborted){y(D,A,B,H,J,I)}},complete:function(H,I){D.data("marcoPolo").ajax=null;D.data("marcoPolo").ajaxAborted=false;$inputParent.removeClass("mp_busy");B.onRequestAfter&&B.onRequestAfter.call(D,D,A,H,I);D.trigger("marcopolorequestafter",[D,A,H,I])}})}},B.delay)};var n=function(D,A,E,B,C){if(C.hideOnSelect){q(B)}E.data("marcoPolo").selected=D;C.onSelect&&C.onSelect.call(E,D,A,E,B);E.trigger("marcopoloselect",[D,A,E,B]);E.data("marcoPolo").value=E.val()};var w=function(C,A,B){i(C);if(B.required&&!C.data("marcoPolo").selected){C.val("")}q(A)};var v={init:function(A){return this.each(function(){var E=b(this);if(E.data("marcoPolo")){return}var D=E.attr("autocomplete");E.attr("autocomplete","off");var B=b('<ol class="mp_list" />').hide().insertAfter(E);var C=p(b.extend({},g,A),E);E.data("marcoPolo",{ajax:null,ajaxAborted:false,autocomplete:D,documentMouseup:null,focus:false,$list:B,mousedown:false,selected:null,selectedMouseup:false,settings:C,timer:null,value:E.val()});E.bind("focus.marcoPolo",function(){E.data("marcoPolo").focus=true;z(C.label);if(E.data("marcoPolo").selectedMouseup){E.data("marcoPolo").selectedMouseup=false}else{C.onFocus&&C.onFocus.call(E,E,B);E.trigger("marcopolofocus",[E,B]);a(E.val(),E,B,C)}}).bind("keydown.marcoPolo",function(G){switch(G.which){case k.UP:G.preventDefault();o(B);e(B);break;case k.DOWN:G.preventDefault();t(B);e(B);break;case k.ENTER:G.preventDefault();var F=d(B);if(F.length){n(F.data("marcoPolo"),F,E,B,C)}break;case k.ESC:w(E,B,C);break}}).bind("keyup.marcoPolo",function(F){if(E.val()!==E.data("marcoPolo").value){a(E.val(),E,B,C)}}).bind("blur.marcoPolo",function(){E.data("marcoPolo").focus=false;setTimeout(function(){if(!E.data("marcoPolo").mousedown){w(E,B,C);u(C.label,E);B.empty()}},1)});B.mousedown(function(){E.data("marcoPolo").mousedown=true}).delegate("li.mp_selectable","mouseover",function(){c(b(this),B)}).delegate("li.mp_selectable","mouseout",function(){j(b(this))}).delegate("li.mp_selectable","mouseup",function(){var F=b(this);n(F.data("marcoPolo"),F,E,B,C);E.data("marcoPolo").selectedMouseup=true;E.focus()});E.data("marcoPolo").documentMouseup=function(){E.data("marcoPolo").mousedown=false;if(!E.data("marcoPolo").focus&&B.is(":visible")){w(E,B,C);u(C.label,E);B.empty()}};b(document).bind("mouseup.marcoPolo",E.data("marcoPolo").documentMouseup);if(C.selected){n(C.selected,null,E,B,C)}z(C.label,E)})},change:function(A){return this.each(function(){var E=b(this);var D=E.data("marcoPolo");var B=D.$list;var C=D.settings;if(!D){return}if(A!==D.value){E.val(A);h(A,E,B,C);w(E,B,C);B.empty()}})},destroy:function(){return this.each(function(){var D=b(this);var C=D.data("marcoPolo");var A=C.$list;var B=C.settings;if(!C){return}A.remove();if(C.autocomplete!=="off"){D.removeAttr("autocomplete")}if(B.label){B.label.removeClass("mp_label")}b(document).unbind("mouseup.marcoPolo",D.data("marcoPolo").documentMouseup);D.unbind(".marcoPolo").removeData("marcoPolo")})},option:function(E,C){if(typeof E==="undefined"){var D=b(this);var B=D.data("marcoPolo");var A=B.settings;if(!B){return}return A}else{if(typeof C==="undefined"){if(b.isPlainObject(E)){return this.each(function(){var H=b(this);var G=H.data("marcoPolo");var F=G.settings;if(!G){return}F=b.extend(F,E);p(F,H)})}else{var D=b(this);var B=D.data("marcoPolo");var A=B.settings;if(!B){return}return A[E]}}else{return this.each(function(){var H=b(this);var G=H.data("marcoPolo");var F=G.settings;if(!G){return}F[E]=C;p(F,H)})}}},search:function(A){return this.each(function(){var C=b(this);var B=C.data("marcoPolo");if(!B){return}if(typeof A!=="undefined"){C.val(A)}C.focus()})}};b.fn.marcoPolo=function(A){if(v[A]){return v[A].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof A==="object"||!A){return v.init.apply(this,arguments)}else{b.error("Method "+A+" does not exist on jQuery.marcoPolo")}}}})(jQuery);